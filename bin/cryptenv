#!/bin/bash

if [ "x$1" = "x" ]; then
    echo "USAGE: $(basename $0) environment"
    exit 1
fi

if [ ! -f /var/lib/cryptenv/$1 ]; then
    echo "$(basename $0): could not find environment: \"$1\""
    exit 1
fi

#if [ -d /media/$1 ]; then
    #echo "$(basename $0): fs \"$1\" appears to be already mounted!"
    #exit 1
#fi

sudo whoami > /dev/null

set -e -x

LODEV=$(sudo losetup -f)
sudo losetup $LODEV /var/lib/cryptenv/$1
sudo cryptsetup luksOpen $LODEV $1
sudo mkdir /media/$1
sudo mount /dev/mapper/$1 /media/$1

CRYPTENV=$1 bash

sudo umount /media/$1
sudo rmdir /media/$1
sudo cryptsetup luksClose $1
sudo losetup -d $LODEV
